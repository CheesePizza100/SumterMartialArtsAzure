<div class="admin-container">
  <!-- Student Grid View -->
  <div *ngIf="!selectedStudent">
    <div class="header-section">
      <h1>Student Management</h1>
      <mat-form-field class="search-field" appearance="outline">
        <mat-label>Search students...</mat-label>
        <input matInput
               [(ngModel)]="searchTerm"
               (ngModelChange)="onSearchChange()"
               placeholder="Name, email, or program">
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>
    </div>

    <!-- Loading State -->
    <div *ngIf="isLoading" class="loading-container">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Loading students...</p>
    </div>

    <!-- Students Table -->
    <div *ngIf="!isLoading" class="table-container mat-elevation-z8">
      <table mat-table [dataSource]="filteredStudents">

        <!-- Name Column -->
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>Student</th>
          <td mat-cell *matCellDef="let student">
            <div class="student-cell">
              <div class="avatar">
                <mat-icon>person</mat-icon>
              </div>
              <strong>{{ student.name }}</strong>
            </div>
          </td>
        </ng-container>

        <!-- Contact Column -->
        <ng-container matColumnDef="contact">
          <th mat-header-cell *matHeaderCellDef>Contact</th>
          <td mat-cell *matCellDef="let student">
            <div class="contact-info">
              <div>{{ student.email }}</div>
              <small>{{ student.phone }}</small>
            </div>
          </td>
        </ng-container>

        <!-- Programs Column -->
        <ng-container matColumnDef="programs">
          <th mat-header-cell *matHeaderCellDef>Programs & Ranks</th>
          <td mat-cell *matCellDef="let student">
            <div class="programs-cell">
              <div *ngFor="let program of student.programs" class="program-item">
                <strong>{{ program.name }}:</strong>
                <span class="rank">{{ program.rank }}</span>
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Attendance Column -->
        <ng-container matColumnDef="attendance">
          <th mat-header-cell *matHeaderCellDef>Attendance</th>
          <td mat-cell *matCellDef="let student">
            <div class="attendance-info">
              <div>{{ student.attendance.last30Days }} / 30 days</div>
              <small>{{ student.attendance.attendanceRate }}% rate</small>
            </div>
          </td>
        </ng-container>

        <!-- Last Test Column -->
        <ng-container matColumnDef="lastTest">
          <th mat-header-cell *matHeaderCellDef>Last Test</th>
          <td mat-cell *matCellDef="let student">
            {{ getLastTestDate(student) }}
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row
            *matRowDef="let row; columns: displayedColumns;"
            class="clickable-row"
            (click)="selectStudent(row)"></tr>
      </table>

      <div *ngIf="filteredStudents.length === 0" class="no-data">
        <p>No students found.</p>
      </div>
    </div>
  </div>

  <!-- Student Detail View -->
  <div *ngIf="selectedStudent" class="student-detail">
    <div class="back-button-container">
      <button mat-button (click)="backToList()">
        <mat-icon>arrow_back</mat-icon>
        Back to Students
      </button>
    </div>

    <div class="detail-card mat-elevation-z4">
      <!-- Student Header -->
      <div class="student-header">
        <div class="header-left">
          <div class="avatar-large">
            <mat-icon>person</mat-icon>
          </div>
          <div class="header-info">
            <h2>{{ selectedStudent.name }}</h2>
            <p>{{ selectedStudent.email }}</p>
            <p>{{ selectedStudent.phone }}</p>
          </div>
        </div>
        <div class="header-right">
          <div class="stat-label">Total Classes Attended</div>
          <div class="stat-value">{{ selectedStudent.attendance.total }}</div>
        </div>
      </div>

      <!-- Tabs -->
      <mat-tab-group [(selectedIndex)]="activeTab">
        <!-- Programs & Ranks Tab -->
        <mat-tab label="Programs & Ranks">
          <div class="tab-content">
            <div *ngFor="let program of selectedStudent.programs" class="program-card">
              <div class="program-header">
                <div>
                  <h3>{{ program.name }}</h3>
                  <p class="current-rank">
                    Current Rank: <span class="rank-badge">{{ program.rank }}</span>
                  </p>
                </div>
                <div class="program-dates">
                  <div>Enrolled: {{ formatDate(program.enrolledDate) }}</div>
                  <div *ngIf="program.lastTest">
                    Last Test: {{ formatDate(program.lastTest) }}
                  </div>
                </div>
              </div>
              <div *ngIf="program.testNotes" class="instructor-notes">
                <strong>Instructor Notes</strong>
                <p>{{ program.testNotes }}</p>
              </div>
            </div>
          </div>
        </mat-tab>

        <!-- Test History Tab -->
        <mat-tab label="Test History">
          <div class="tab-content">
            <div *ngIf="selectedStudent.testHistory.length > 0; else noTests">
              <div *ngFor="let test of selectedStudent.testHistory" class="test-card">
                <div class="test-header">
                  <div>
                    <div class="test-title">
                      <h4>{{ test.program }}</h4>
                      <mat-chip [color]="getResultColor(test.result)" selected>
                        {{ test.result }}
                      </mat-chip>
                    </div>
                    <p>Promoted to: <strong>{{ test.rank }}</strong></p>
                  </div>
                  <div class="test-date">
                    {{ formatDate(test.date) }}
                  </div>
                </div>
                <div *ngIf="test.notes" class="test-notes">
                  {{ test.notes }}
                </div>
              </div>
            </div>
            <ng-template #noTests>
              <div class="empty-state">
                <mat-icon>description</mat-icon>
                <p>No test history yet</p>
              </div>
            </ng-template>
          </div>
        </mat-tab>

        <!-- Attendance Tab -->
        <mat-tab label="Attendance">
          <div class="tab-content">
            <div class="attendance-stats">
              <div class="stat-card blue">
                <div class="stat-number">{{ selectedStudent.attendance.last30Days }}</div>
                <div class="stat-text">Last 30 Days</div>
              </div>
              <div class="stat-card green">
                <div class="stat-number">{{ selectedStudent.attendance.attendanceRate }}%</div>
                <div class="stat-text">Attendance Rate</div>
              </div>
              <div class="stat-card purple">
                <div class="stat-number">{{ selectedStudent.attendance.total }}</div>
                <div class="stat-text">Total Classes</div>
              </div>
            </div>

            <div class="attendance-pattern">
              <h4>Attendance Pattern</h4>
              <div class="pattern-row">
                <div class="pattern-label">This Week</div>
                <div class="pattern-bar">
                  <div class="pattern-fill" [style.width.%]="80"></div>
                </div>
                <div class="pattern-value">4/5 days</div>
              </div>
              <div class="pattern-row">
                <div class="pattern-label">Last Week</div>
                <div class="pattern-bar">
                  <div class="pattern-fill" [style.width.%]="100"></div>
                </div>
                <div class="pattern-value">5/5 days</div>
              </div>
              <div class="pattern-row">
                <div class="pattern-label">2 Weeks Ago</div>
                <div class="pattern-bar">
                  <div class="pattern-fill" [style.width.%]="60"></div>
                </div>
                <div class="pattern-value">3/5 days</div>
              </div>
            </div>

            <div class="attendance-note">
              <mat-icon>info</mat-icon>
              <span>
                <strong>Note:</strong> Student maintaining excellent attendance.
                Eligible for upcoming belt test.
              </span>
            </div>
          </div>
        </mat-tab>
      </mat-tab-group>
    </div>
  </div>
</div>
